# hadolint ignore=DL3007
FROM public.ecr.aws/l6m2t8p7/docker-2048:latest AS source

# Stage 2: Create a clean, secure image using nginxinc/nginx-unprivileged
# Fixes DL3007 (Pin version) and CIS-DI-0001 (Non-root user)
FROM nginxinc/nginx-unprivileged:1.25-alpine

# Copy static files from upstream
# The unprivileged image serves from /usr/share/nginx/html by default
COPY --from=source /usr/share/nginx/html /usr/share/nginx/html

# Expose port 8080 (default for unprivileged nginx)
EXPOSE 8080

# Configure Nginx to run as non-root (Port 8080) to satisfy CIS-DI-0001
RUN sed -i 's/listen  *80;/listen 8080;/' /etc/nginx/conf.d/default.conf && \
    sed -i 's/listen  *\[::\]:80;/listen [::]:8080;/' /etc/nginx/conf.d/default.conf && \
    # Fix permissions for non-root user
    chown -R nginx:nginx /var/cache/nginx /var/log/nginx /etc/nginx/conf.d /usr/share/nginx/html && \
    touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid

# Fix CIS-DI-0006: Add HEALTHCHECK instruction
HEALTHCHECK --interval=30s --timeout=5s \
  CMD wget -q --spider http://localhost:8080/ || exit 1

# Switch to non-root user
USER nginx

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]
